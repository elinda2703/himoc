<!DOCTYPE html>
<html>
<head>
  <title>Urban Taxonomy</title>
  <meta charset="utf-8" />

  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.0.1/dist/maplibre-gl.css" />
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <script src="https://unpkg.com/maplibre-gl@5.0.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/pmtiles@4.2.1/dist/pmtiles.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100vw; }

    /* --- CHART WIDGET (Right Side) --- */
    #chart-toggle {
      position: absolute; top: 10px; right: 10px;
      background: white; border-radius: 6px;
      padding: 6px 10px; cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,.3);
      z-index: 1003;
      font-size: 16px;
    }

    #chart-container {
      position: absolute;
      top: 45px; right: 10px;
      width: 300px;
      max-height: 90vh;
      overflow-y: auto;
      background: white;
      padding: 15px;
      border-radius: 8px;
      z-index: 1002;
      display: none;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      font-family: sans-serif;
      font-size: 12px;
    }

    #chart-container select, #chart-container button {
      width: 100%; margin-top: 5px; padding: 5px; cursor: pointer;
    }

    /* Fixed height wrapper to prevent jumping */
    .chart-wrapper {
      position: relative;
      height: 220px;
      width: 100%;
      margin-bottom: 10px;
    }

    /* Custom Chart Legend (Bottom of widget) */
    #custom-legend {
      margin-top: 10px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .legend-item {
      display: flex; align-items: center; margin-bottom: 4px; font-size: 11px; color: #333;
    }
    .legend-color {
      width: 12px; height: 12px; border-radius: 2px; margin-right: 8px; flex-shrink: 0;
    }

    /* --- MAP LEGEND (Top-Left / Original Style) --- */
    #legend {
      position: absolute; 
      top: 130px; /* Below navigation controls */
      left: 10px; 
      background: white; 
      border: 1px solid #ccc; 
      border-radius: 4px; 
      padding: 5px; 
      z-index: 1001; 
      font-size: 12px; 
      font-family: sans-serif; 
      box-shadow: 0 0 0 2px rgba(0,0,0,.1);
    }
    #legend-toggle {
      background: none; border: none; cursor: pointer; 
      font-size: 16px; padding: 0; width: 20px; height: 20px;
      display: flex; align-items: center; justify-content: center;
    }
    #legend-items {
      display: none; /* Hidden by default */
      margin-top: 5px;
      padding-top: 5px;
      border-top: 1px solid #eee;
      min-width: 200px;
    }
  </style>
</head>

<body>

<div id="legend">
    <button id="legend-toggle" title="Show Legend"><i class="fa-solid fa-list"></i></button>
    <div id="legend-items"></div>
</div>

<div id="chart-toggle"><i class="fa-solid fa-chart-pie"></i></div>

<div id="chart-container">
  <b style="font-size:14px;">Statistics</b>
  <select id="modeSelect">
    <option value="viewport">Window extent</option>
    <option value="polygon">Polygon area</option>
  </select>

  <div id="polygon-tools" style="display:none;">
    <button id="drawBtn">Draw polygon</button>
    <button id="deleteBtn">Delete polygon</button>
  </div>

  <h4 style="margin:15px 0 10px;">Taxonomy</h4>
  
  <div class="chart-wrapper">
      <canvas id="typeChart"></canvas>
  </div>

  <div id="custom-legend"></div>
</div>

<div id="map"></div>

<script>
/* ---------- DATA CONFIG ---------- */
const uniqueColors = ["#4069BC","#7CBAE4","#E69C63","#eec1d5","#E0665F","#ECBF43","#b2cd32","#1F943E"];
const clusterNames = {
  1:"Incoherent Large-Scale Homogenous Fabric",
  2:"Incoherent Large-Scale Heterogenous Fabric",
  3:"Incoherent Small-Scale Linear Fabric",
  4:"Incoherent Small-Scale Sparse Fabric",
  5:"Incoherent Small-Scale Compact Fabric",
  6:"Coherent Interconnected Fabric",
  7:"Coherent Dense Disjoint Fabric",
  8:"Coherent Dense Adjacent Fabric"
};

let protocol = new pmtiles.Protocol({ metadata:true });
maplibregl.addProtocol("pmtiles", protocol.tile);

let mapping = {};
fetch('./data/mapping.json').then(r=>r.json()).then(d=>mapping=d);

/* ---------- MAP INIT ---------- */
const map = new maplibregl.Map({
  style: "data/positron.json",
  container: "map",
  zoom: 13,
  center: [14.436035, 50.078292],
});

map.addControl(new maplibregl.NavigationControl(),'top-left');

/* ---------- DRAW TOOL ---------- */
MapboxDraw.constants.classes.CONTROL_BASE = 'maplibregl-ctrl';
MapboxDraw.constants.classes.CONTROL_PREFIX = 'maplibregl-ctrl-';
const draw = new MapboxDraw({ displayControlsDefault:false, controls:{} });
map.addControl(draw);

/* ---------- UI LOGIC ---------- */
let chartVisible=false, myChart=null;
const toggle=document.getElementById('chart-toggle');
const box=document.getElementById('chart-container');
const mode=document.getElementById('modeSelect');
const tools=document.getElementById('polygon-tools');
const drawBtn=document.getElementById('drawBtn');
const deleteBtn=document.getElementById('deleteBtn');

toggle.onclick=()=>{ 
  chartVisible=!chartVisible; 
  box.style.display=chartVisible?'block':'none'; 
  if(chartVisible) updateStats(); 
};

mode.onchange=()=>{
  tools.style.display = mode.value==='polygon' ? 'block' : 'none';
  updateStats();
};

drawBtn.onclick=()=> draw.changeMode('draw_polygon');
deleteBtn.onclick=()=> { draw.deleteAll(); updateStats(); };

/* ---------- MAP LAYERS & LEGEND ---------- */
map.on('load',()=>{
  map.addSource('buildings-source',{
    type:'vector',
    url:'pmtiles://https://s3.cl4.du.cesnet.cz/4f4743b6_4043_4e02_a3ba_0452aa7523a2:uscuni-public/urban_taxonomy/v202511/complete.pmtiles'
  });

  const layers = map.getStyle().layers;
  let firstSymbolId;
  for (let i=0;i<layers.length;i++) if(layers[i].type==='symbol'){ firstSymbolId=layers[i].id; break; }

  const fillColor=["match",["get","level_7_label"], ...Object.entries(mapping).flatMap(([k,v])=>[k,uniqueColors[v-1]]), "#ccc"];

  map.addLayer({
    id:'buildings',
    type:'fill',
    source:'buildings-source',
    'source-layer':'buildings',
    paint:{'fill-color':fillColor,'fill-opacity':0.7}
  }, firstSymbolId);

  // POPUP
  map.on('click','buildings',e=>{
    const leaf=e.features[0].properties.level_7_label;
    new maplibregl.Popup().setLngLat(e.lngLat)
      .setHTML(`<h4>${clusterNames[mapping[leaf]]}</h4>`).addTo(map);
  });
  map.on('mouseenter','buildings',()=>map.getCanvas().style.cursor='pointer');
  map.on('mouseleave','buildings',()=>map.getCanvas().style.cursor='');

  // --- BUILD LEFT-SIDE MAP LEGEND (Restored) ---
  const legendItemsDiv = document.getElementById('legend-items');
  const orderedKeys = ["6", "8", "7", "1", "2", "3", "4", "5"];
  
  let html = '';
  orderedKeys.forEach(key => {
    const clusterNum = parseInt(key, 10);
    const color = uniqueColors[clusterNum - 1];
    html += `
      <div style="display: flex; align-items: center; margin-bottom: 2px;">
        <div style="width: 15px; height: 15px; background-color: ${color}; margin-right: 8px; border-radius: 3px;"></div>
        <span>${clusterNames[key]}</span>
      </div>`;
  });
  legendItemsDiv.innerHTML = html;

  document.getElementById('legend-toggle').onclick = () => {
    const isHidden = legendItemsDiv.style.display === 'none' || legendItemsDiv.style.display === '';
    legendItemsDiv.style.display = isHidden ? 'block' : 'none';
  };
});

/* ---------- STATISTICS & CHART ---------- */
function updateStats(){
  if(!chartVisible||Object.keys(mapping).length===0){ return; }

  let features=[];
  if(mode.value==='polygon'){
    const d=draw.getAll();
    if(!d.features.length){ 
        if(myChart) myChart.destroy();
        document.getElementById('custom-legend').innerHTML = '<div style="text-align:center; color:#666; margin-top:20px;">Draw a polygon to see stats</div>';
        return; 
    }
    const poly=d.features[0];
    const bbox=turf.bbox(poly);
    const sw=map.project([bbox[0],bbox[1]]);
    const ne=map.project([bbox[2],bbox[3]]);
    features=map.queryRenderedFeatures([sw,ne],{layers:['buildings']})
      .filter(f=>turf.booleanPointInPolygon(turf.centerOfMass(f),poly));
  } else {
    features=map.queryRenderedFeatures({layers:['buildings']});
  }

  const counts={1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0};
  let total=0;

  features.forEach(f=>{
    const c=mapping[f.properties.level_7_label];
    if(c){counts[c]++; total++;}
  });

  if(total>0) renderChart(counts,total);
}

function renderChart(counts,total){
  const ctx=document.getElementById('typeChart').getContext('2d');
  const legendDiv=document.getElementById('custom-legend');
  
  if(myChart) myChart.destroy();
  legendDiv.innerHTML = '';

  const activeKeys=Object.keys(counts).filter(k=>counts[k]>0);
  const dataValues = activeKeys.map(k=>counts[k]);
  const bgColors = activeKeys.map(k=>uniqueColors[k-1]);
  const labels = activeKeys.map(k=>clusterNames[k]);

  myChart=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels: labels,
      datasets:[{
        data: dataValues,
        backgroundColor: bgColors,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      // FORCE SMOOTH "CIRCLE" ANIMATION
      animation: {
        duration: 1000,
        easing: 'easeOutQuart',
        animateRotate: true,
        animateScale: true
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: () => null,
            label: function(context) {
              const value = context.raw;
              const percentage = Math.round((value / total) * 100) + '%';
              return context.chart.data.labels[context.dataIndex] + ': ' + percentage;
            }
          }
        }
      }
    }
  });

  // BUILD WIDGET LEGEND
  activeKeys.forEach(key => {
    const item = document.createElement('div');
    item.className = 'legend-item';
    const pct = Math.round((counts[key]/total)*100);
    item.innerHTML = `
      <div class="legend-color" style="background:${uniqueColors[key-1]}"></div>
      <div>${clusterNames[key]} <strong style="margin-left:5px;">${pct}%</strong></div>
    `;
    legendDiv.appendChild(item);
  });
}

map.on('draw.create',updateStats);
map.on('draw.update',updateStats);
map.on('moveend',()=>{ if(chartVisible&&mode.value==='viewport') updateStats(); });
</script>
</body>
</html>